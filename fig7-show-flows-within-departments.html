<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
	<meta name="description" content="">
	<meta name="author" content="webThemez.com">

	<title>Retro - Free Consulting Responsive Website Template</title>

	<link rel="shortcut icon" href="assets/images/favicon.png">

	<link rel="stylesheet" media="screen" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
	<link rel="stylesheet" href="assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/font-awesome.min.css">

	<!-- Custom styles for our template -->
	<link rel="stylesheet" href="assets/css/bootstrap-theme.css" media="screen">
	<link rel="stylesheet" href="assets/css/style.css">

	<script src="./assets/js/d3/d3.min.js"></script>

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	<script src="assets/js/html5shiv.js"></script>
	<script src="assets/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<!-- Fixed navbar -->
	<div class="navbar navbar-inverse navbar-fixed-top headroom">
		<div class="container">
			<div class="navbar-header">
				<!-- Button for smallest screens -->
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"><span
						class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
				<a class="navbar-brand" href="index.html"><img src="assets/images/logo.png"
						alt="Retro HTML5 template"></a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav pull-right">
					<li class="active"><a href="#">Home</a></li>
					<li><a href="research.html">Our Research</a></li>
					<!-- <li><a href="portfolio.html">Portfolio</a></li> -->
					<li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Analysis <b
								class="caret"></b></a>
						<ul class="dropdown-menu">
							<li><a href="fig1-show-the-ratio-through-diff-view.html">Fig.1 StackBarChart</a></li>
							<li><a href="fig2-show-the-ratio-through-diff-department.html">Fig.2 StackBarChart</a></li>
							<li><a href="fig3-show-flows-between-regions.html">Fig.3 Sankey</a></li>
							<li><a href="fig4-show-flows-between-regions-with-department.html">Fig.4 Sankey</a></li>
							<li><a href="fig5-show-flows-between-contries.html">Fig.5 Sankey</a></li>
							<li><a href="fig6-show-flows-between-countris-with-department.html">Fig.6 Sankey</a></li>
							<li><a href="fig7-show-flows-within-departments.html">Fig.7 Chord</a></li>
						</ul>
					</li>
					<li><a href="publications.html">Publications</a></li>
					<li><a href="about.html">About Team</a></li>
				</ul>
			</div>
			<!--/.nav-collapse -->
		</div>
	</div>
	<!-- /.navbar -->

	<header id="head" class="secondary"></header>


	<!-- container -->
	<div class="container">

		<div class="container researchlist">
			<div class="row">
				<div class="col-md-12">
					<header class="page-header">
						<h1 class="page-title">各城市的资源要素在生产/消费视角下的跨地区流动</h1>
					</header>
				</div>
			</div>

			<div class="row">
				<div class="col-sm-6">
					<div id="dropdown_container_EWCL">
						<select id="selectEWCL" class="ds-form-input-container"> </select>
					</div>
				</div>
				<div class="col-sm-6">
					<div id="dropdown_container_region">
						<select id="selectRegion" class="ds-form-input-container"> </select>
					</div>
				</div>
			</div>
			<div class="row">
				<svg width="800" height="800" id="CircosArea" class="svg_panel"
					style='display: block; margin: 0 auto;'></svg>
			</div>
		</div><!-- End container -->

	</div> <!-- /container -->

	<footer id="footer" class="top-space">
		<div class="footer2">
			<div class="container">
				<div class="row">

					<div class="col-md-6 panel">
						<div class="panel-body">
							<p class="simplenav">
								<a href="index.html">Home</a> |
								<a href="about.html">About</a> |
								<a href="research.html">research</a> |
								<a href="portfolio.html">Portfolio</a> |
								<a href="publications.html">publications</a>
							</p>
						</div>
					</div>

					<div class="col-md-6 panel">
						<div class="panel-body">
							<p class="text-right">
								Copyright &copy; 2014. Template by <a href="http://webthemez.com/"
									rel="develop">WebThemez.com</a>
							</p>
						</div>
					</div>

				</div> <!-- /row of panels -->
			</div>
		</div>

	</footer>


	<!-- JavaScript libs are placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
	<script src="assets/js/headroom.min.js"></script>
	<script src="assets/js/jQuery.headroom.min.js"></script>
	<script src="assets/js/custom.js"></script>

	<script type="text/javascript">

		var item_list = ["Energy", "Water", "CO2", "Land"],
			unit_list = { "Energy": "Mtce", "Water": "Mt", "CO2": "Mt(CO2e)", "Land": "Kha" },
			dept_list = ['Agriculture', 'Food&tabacco', 'Electricity, Gas &Water', 'Construction', 'Transport', 'Services', 'Others'],
			region_list = ['北京', '天津', '河北', '山西', '内蒙古', '辽宁', '吉林', '黑龙江', '上海', '江苏', '浙江', '安徽', '福建', '江西', '山东', '河南', '湖北', '湖南', '广东', '广西', '海南', '重庆', '四川', '贵州', '云南', '陕西', '甘肃', '青海', '宁夏', '新疆'];
		// 将item_list和region_list中的项目增加至两个下拉框
		d3.select('#selectEWCL').selectAll("option")
			.data(item_list).enter()
			.append("option")
			.text(function (d) { return d; })
			.attr("value", function (d) { return d; });
		d3.select('#selectRegion').selectAll("option")
			.data(region_list).enter()
			.append("option")
			.text(function (d) { return d; })
			.attr("value", function (d) { return d; });

		init();
		function init() {
			d3.json("assets/data/fig7_data.json").then(d => {
				drawChart(d); // 获取数据成功后，绘图
				$('#selectEWCL').change(function () { drawChart(d); });// 增加 [要素] 和 [省份] 2个下拉框的响应函数
				$('#selectRegion').change(function () { drawChart(d); });
			});
		}

		function drawChart(d) {

			$('#CircosArea').empty();// 清空绘图区

			var selectEWCL = document.getElementById('selectEWCL'),
				selectRegion = document.getElementById('selectRegion');
			var sel_EWCL = selectEWCL.options[selectEWCL.selectedIndex].value,
				sel_region = selectRegion.options[selectRegion.selectedIndex].value;

			var matrix = [];
			for (var p in d) {
				if (sel_region == d[p].province && sel_EWCL == d[p].EWCL)
					matrix = d[p].data;
			}

			var names = dept_list;

			// The following code is the typical routine of my d3.js code. 
			const svg = d3.select('#CircosArea');
			const width = svg.attr('width');
			const height = svg.attr('height');
			svg.attr("viewBox", [-width / 2, -height / 2, width, height]);

			const innerRadius = Math.min(width, height) * 0.5 - 90;
			const outerRadius = innerRadius + 10;

			// d3.chord
			var chord = d3.chordDirected().padAngle(10 / innerRadius).sortSubgroups(d3.descending).sortChords(d3.descending);
			// chord为由matrix（N维）方阵生成的N*N条弦数据
			// chord.groups为大小为N的数据组
			const chords = chord(matrix);

			const color = d3.scaleOrdinal(names, d3.quantize(d3.interpolateRainbow, names.length));
			// const color = d3.scaleOrdinal().domain(names).range(d3.schemePastel1);
			// const color = d3.scaleOrdinal().domain(names).range(d3.schemeSet3);
			const arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);

			// 此group为按chords.groups的数量建立起来的图形g分组
			var group = svg.append('g')
				.attr("font-size", 12)
				.attr("font-family", "sans-serif")
				.selectAll("g")
				.data(chords.groups)
				.join("g");
			// 为每一个分组绘制弧形
			group.append("path")
				.attr("fill", d => color(names[d.index]))
				.attr("d", arc);

			group.append("text")
				.each(d => (d.angle = (d.startAngle + d.endAngle) / 2))
				.attr("dy", "0.35em")
				.attr("transform", d => `
										rotate(${(d.angle * 180 / Math.PI - 90)})
										translate(${outerRadius + 5})
										${d.angle > Math.PI ? "rotate(180)" : ""}
									`)
				.attr("text-anchor", d => d.angle > Math.PI ? "end" : null)
				.text(d => names[d.index]);

			group.append("title")
				.text(d => `${names[d.index]}
${(d3.format(",.1~f"))(d3.sum(chords, c => (c.source.index === d.index) * c.source.value)) + unit_list[sel_EWCL]} outgoing →
${(d3.format(",.1~f"))(d3.sum(chords, c => (c.target.index === d.index) * c.source.value)) + unit_list[sel_EWCL]} incoming ←`);

			const ribbon = d3.ribbonArrow().radius(innerRadius - 1).padAngle(1 / innerRadius);
			svg.append("g")
				.attr("fill-opacity", 0.75)
				.selectAll("path")
				.data(chords)
				.join("path")
				.style("mix-blend-mode", "multiply")
				.attr("fill", d => color(names[d.target.index]))
				.attr("d", ribbon)
				.append("title")
				.text(d => `${names[d.source.index]} → ${names[d.target.index]} ${(d3.format(",.1~f"))(d.source.value)}` + unit_list[sel_EWCL])

		}

	</script>
</body>

</html>